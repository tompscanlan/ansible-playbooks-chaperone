---

- name: Prepare VMs
  hosts: photon
  tasks:

    - name: Open Service Ports
      iptables:
        chain: INPUT
        protocol: tcp
        destination_port: "{{ item }}"
        jump: ACCEPT
      with_items:
        - 80
        - 1883
        - 2003
        - 2004
        - 7002
        - 9001
      tags: ["docker"]

    - name: Run Mosquitto service
      docker_container:
        name: mosquitto
        image: toke/mosquitto
        command: /usr/sbin/mosquitto -v -c /mqtt/config/mosquitto.conf
        state: started
        published_ports:
          - 1883:1883
          - 9001:9001
      run_once: true
      tags: ["docker"]

    - name: Run Graphite service
      docker_container:
        name: graphite
        image: nickstenning/graphite
        state: started
        published_ports:
          - 80:80
          - 2003:2003
          - 2004:2004
          - 7002:7002
      run_once: true
      tags: ["docker"]